---
- name: Copy ansible-drift
  ansible.builtin.template:
    src: ansible-drift.j2
    dest: /usr/local/bin/ansible-drift
    owner: root
    group: root
    mode: "0755"

- name: Ensure user is present
  ansible.builtin.user:
    name: "{{ drift_user }}"

- name: Make sure we have .ssh dir
  ansible.builtin.file:
    path: /home/{{ drift_user }}/.ssh
    state: directory
    owner: "{{ drift_user }}"
    group: "{{ drift_user }}"
    mode: "0700"

- name: Make sure we have ssh private key
  ansible.builtin.copy:
    content: "{{ drift_ssh_private_key }}"
    dest: /home/{{ drift_user }}/.ssh/id_rsa
    owner: "{{ drift_user }}"
    group: "{{ drift_user }}"
    mode: "0600"
  when: drift_ssh_private_key|d()

- name: Make sure we have ssh public key
  ansible.builtin.copy:
    content: "{{ drift_ssh_public_key }}\n"
    dest: /home/{{ drift_user }}/.ssh/id_rsa.pub
    owner: "{{ drift_user }}"
    group: "{{ drift_user }}"
    mode: "0644"
  when: drift_ssh_private_key|d()

- name: Make sure sq is installed
  ansible.builtin.apt:
    name: sq
    update_cache: true
  when: drift_encrypt_mails

- name: Install pgp public key
  when: drift_encrypt_mails
  block:
  - name: Assert that public pgp key is non-empty
    ansible.builtin.assert:
      that: "drift_pgp_public_key != ''"
      fail_msg: "'drift_encrypt_mails' is true but 'drift_pgp_public_key' is empty"

  - name: Make sure we have pgp public key
    ansible.builtin.copy:
      content: "{{ drift_pgp_public_key }}\n"
      dest: /home/{{ drift_user }}/pubkey.asc
      owner: "{{ drift_user }}"
      group: "{{ drift_user }}"
      mode: "0644"

  - name: Make sure pgp public key is not malformed
    ansible.builtin.command:
      cmd: "sq inspect /home/{{ drift_user }}/pubkey.asc"
    changed_when: False

- name: Create cron job
  ansible.builtin.template:
    src: cron.j2
    dest: /etc/cron.d/ansible-drift
    owner: root
    group: root
    mode: "0644"
  when: drift_playbook|d()

- name: Delete cron job
  ansible.builtin.file:
    path: /etc/cron.d/ansible-drift
    state: absent
  when: not drift_playbook|d()

- name: Make sure we have .gnupg dir
  ansible.builtin.file:
    path: /home/{{ drift_user }}/.gnupg
    state: directory
    owner: "{{ drift_user }}"
    group: "{{ drift_user }}"
    mode: "0700"

- name: Cache gpg credentials for long time
  ansible.builtin.copy:
    content: |
      # cache credentials 400 days
      default-cache-ttl 34560000
      max-cache-ttl 34560000
    dest: /home/{{ drift_user }}/.gnupg/gpg-agent.conf
    owner: "{{ drift_user }}"
    group: "{{ drift_user }}"
    mode: "0644"

- name: Don't kill gpg-agent after logout
  ansible.builtin.command: loginctl enable-linger {{ drift_user }}
  args:
    creates: /var/lib/systemd/linger/{{ drift_user }}
  tags:
    - molecule-notest
